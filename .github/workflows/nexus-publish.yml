name: Nexus Publish

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      artifactName:
        description: 'Name of the GitHub artifact to download'
        required: true
        type: string
      groupId:
        description: 'Maven groupId (e.g., com.example.myapp)'
        required: true
        type: string
      projectName:
        description: 'Project name for POM'
        required: false
        type: string
        default: ''
      projectDescription:
        description: 'Project description for POM'
        required: false
        type: string
        default: ''
      projectUrl:
        description: 'Project URL for POM'
        required: false
        type: string
        default: ''
      licenseName:
        description: 'License name (e.g., MIT License)'
        required: false
        type: string
        default: 'MIT License'
      licenseUrl:
        description: 'License URL'
        required: false
        type: string
        default: 'https://opensource.org/licenses/MIT'
    secrets:
      NEXUS_USERNAME:
        required: true
      NEXUS_PASSWORD:
        required: true
      NEXUS_RELEASE_URL:
        required: true
      NEXUS_SNAPSHOT_URL:
        required: true

jobs:
  publish:
    runs-on: arc-runner-set

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifactName }}
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ğŸ“¦ Downloaded artifacts:"
          find artifacts -type f -name "*.jar" | grep -v -- '-plain.jar' || echo "No JAR files found"

      - name: Publish to Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_RELEASE_URL: ${{ secrets.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ secrets.NEXUS_SNAPSHOT_URL }}
          VERSION: ${{ inputs.version }}
          GROUP_ID: ${{ inputs.groupId }}
          PROJECT_NAME: ${{ inputs.projectName }}
          PROJECT_DESCRIPTION: ${{ inputs.projectDescription }}
          PROJECT_URL: ${{ inputs.projectUrl }}
          LICENSE_NAME: ${{ inputs.licenseName }}
          LICENSE_URL: ${{ inputs.licenseUrl }}
        run: |
          set -e

          # Convert groupId to path (com.example.app -> com/example/app)
          GROUP_PATH="${GROUP_ID//./\/}"

          # Determine repository URL based on version
          if [[ "$VERSION" == *"SNAPSHOT"* ]]; then
            REPO_URL="${NEXUS_SNAPSHOT_URL}"
            echo "ğŸ“ Publishing SNAPSHOT version to: ${REPO_URL}"
          else
            REPO_URL="${NEXUS_RELEASE_URL}"
            echo "ğŸ“ Publishing RELEASE version to: ${REPO_URL}"
          fi

          # Ensure REPO_URL ends with a slash
          if [[ ! "$REPO_URL" =~ /$ ]]; then
            REPO_URL="${REPO_URL}/"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Nexus Publish Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Group ID: ${GROUP_ID}"
          echo "ğŸ·ï¸  Version: ${VERSION}"
          echo "ğŸ“ Repository: ${REPO_URL}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Function to generate POM
          generate_pom() {
            local ARTIFACT_ID=$1
            local POM_PATH=$2
            local POM_VERSION=$3

            cat > "$POM_PATH" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                   http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${POM_VERSION}</version>
          EOF

            # Add optional fields if provided
            if [ -n "$PROJECT_NAME" ]; then
              echo "  <name>${PROJECT_NAME} - ${ARTIFACT_ID}</name>" >> "$POM_PATH"
            fi

            if [ -n "$PROJECT_DESCRIPTION" ]; then
              echo "  <description>${PROJECT_DESCRIPTION}</description>" >> "$POM_PATH"
            fi

            if [ -n "$PROJECT_URL" ]; then
              echo "  <url>${PROJECT_URL}</url>" >> "$POM_PATH"
            fi

            # Add license
            cat >> "$POM_PATH" <<EOF
            <licenses>
              <license>
                <name>${LICENSE_NAME}</name>
                <url>${LICENSE_URL}</url>
              </license>
            </licenses>
          </project>
          EOF
          }

          # Function to upload artifact
          upload_artifact() {
            local JAR_PATH=$1
            local JAR_FILENAME=$(basename "$JAR_PATH")

            # Extract artifact ID by removing version and .jar extension
            # Handles both: cubicolor-core-1.0.0.jar and cubicolor-core-1.0.0-SNAPSHOT.jar
            local ARTIFACT_ID=$(echo "$JAR_FILENAME" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?\.jar$//')

            # Extract actual version from filename
            local ACTUAL_VERSION=$(echo "$JAR_FILENAME" | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?)\.jar$/\1/')

            if [ ! -f "$JAR_PATH" ]; then
              echo "âš ï¸  Warning: $JAR_PATH not found, skipping..."
              return
            fi

            # Skip plain JARs (Spring Boot generates these)
            if [[ "$JAR_PATH" == *"-plain.jar" ]]; then
              echo "â­ï¸  Skipping plain JAR: $ARTIFACT_ID"
              return
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Processing: ${ARTIFACT_ID}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Use actual version from JAR filename
            local USE_VERSION="${ACTUAL_VERSION}"

            # Determine repository URL based on actual version
            local UPLOAD_REPO_URL
            if [[ "$USE_VERSION" == *"SNAPSHOT"* ]]; then
              UPLOAD_REPO_URL="${NEXUS_SNAPSHOT_URL}"
            else
              UPLOAD_REPO_URL="${NEXUS_RELEASE_URL}"
            fi

            # Ensure URL ends with slash
            if [[ ! "$UPLOAD_REPO_URL" =~ /$ ]]; then
              UPLOAD_REPO_URL="${UPLOAD_REPO_URL}/"
            fi

            # Maven path structure
            local MAVEN_BASE="${GROUP_PATH}/${ARTIFACT_ID}/${USE_VERSION}"
            local JAR_UPLOAD_URL="${UPLOAD_REPO_URL}${MAVEN_BASE}/${ARTIFACT_ID}-${USE_VERSION}.jar"
            local POM_UPLOAD_URL="${UPLOAD_REPO_URL}${MAVEN_BASE}/${ARTIFACT_ID}-${USE_VERSION}.pom"

            echo "   ğŸ“‚ Artifact ID: ${ARTIFACT_ID}"
            echo "   ğŸ·ï¸  Version: ${USE_VERSION}"
            echo "   ğŸ“ Source: ${JAR_PATH}"
            echo "   ğŸŒ Target: ${JAR_UPLOAD_URL}"
            echo ""

            # Upload JAR
            echo "   ğŸ“¤ Uploading JAR..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
              --upload-file "${JAR_PATH}" \
              "${JAR_UPLOAD_URL}")

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "   âœ… JAR uploaded successfully (HTTP ${HTTP_CODE})"
            else
              echo "   âŒ JAR upload failed (HTTP ${HTTP_CODE})"
              exit 1
            fi

            # Generate and upload POM
            local POM_PATH="/tmp/${ARTIFACT_ID}-${USE_VERSION}.pom"
            generate_pom "$ARTIFACT_ID" "$POM_PATH" "$USE_VERSION"

            echo "   ğŸ“¤ Uploading POM..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
              --upload-file "${POM_PATH}" \
              "${POM_UPLOAD_URL}")

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "   âœ… POM uploaded successfully (HTTP ${HTTP_CODE})"
            else
              echo "   âš ï¸  POM upload warning (HTTP ${HTTP_CODE})"
            fi

            rm -f "$POM_PATH"
          }

          # Find and upload all JARs
          echo "ğŸ” Searching for artifacts..."
          echo ""

          UPLOADED=0
          while IFS= read -r jar_file; do
            upload_artifact "$jar_file"
            UPLOADED=$((UPLOADED + 1))
          done < <(find artifacts -type f -name "*.jar" | grep -v -- '-plain.jar')

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ¨ Publishing Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Total artifacts published: ${UPLOADED}"
          echo "ğŸ“ Repository: ${REPO_URL}"
          echo "ğŸ·ï¸  Version: ${VERSION}"
          echo ""
          echo "ğŸ“‹ Maven coordinates format:"
          echo "   <dependency>"
          echo "     <groupId>${GROUP_ID}</groupId>"
          echo "     <artifactId>YOUR-ARTIFACT-ID</artifactId>"
          echo "     <version>${VERSION}</version>"
          echo "   </dependency>"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
