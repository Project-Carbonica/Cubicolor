name: Test Nexus Publish

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: arc-runner-set

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build project
        run: ./gradlew build --no-daemon

      - name: Get current version
        id: version
        run: |
          VERSION=$(./gradlew currentVersion -q | grep "Project version:" | awk '{print $3}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          find . -path "*/build/libs/*.jar" ! -name "*-plain.jar" -exec cp {} artifacts/ \;

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts for testing:"
          find artifacts -type f -name "*.jar" | grep -v -- '-plain.jar' || echo "No JAR files found"

      - name: Test Nexus Publish
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_RELEASE_URL: ${{ secrets.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ secrets.NEXUS_SNAPSHOT_URL }}
          VERSION: ${{ steps.version.outputs.version }}
          GROUP_ID: net.cubizor.cubicolor
          PROJECT_NAME: Cubicolor
          PROJECT_DESCRIPTION: A modular color and typography theming library for Java applications
          PROJECT_URL: https://github.com/Project-Carbonica/Cubicolor/
          LICENSE_NAME: MIT License
          LICENSE_URL: https://opensource.org/licenses/MIT
        run: |
          set -e

          # Convert groupId to path (com.example.app -> com/example/app)
          GROUP_PATH="${GROUP_ID//./\/}"

          # Determine repository URL based on version
          if [[ "$VERSION" == *"SNAPSHOT"* ]]; then
            REPO_URL="${NEXUS_SNAPSHOT_URL}"
            echo "üìç Publishing SNAPSHOT version to: ${REPO_URL}"
          else
            REPO_URL="${NEXUS_RELEASE_URL}"
            echo "üìç Publishing RELEASE version to: ${REPO_URL}"
          fi

          # Ensure REPO_URL ends with a slash (remove any existing trailing slash first, then add one)
          REPO_URL="${REPO_URL%/}/"

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üß™ TEST MODE - Nexus Publish Configuration"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ Group ID: ${GROUP_ID}"
          echo "üè∑Ô∏è  Version: ${VERSION}"
          echo "üìç Repository: ${REPO_URL}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""

          # Function to generate POM
          generate_pom() {
            local ARTIFACT_ID=$1
            local POM_PATH=$2
            local POM_VERSION=$3

            cat > "$POM_PATH" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                   http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${POM_VERSION}</version>
          EOF

            # Add optional fields if provided
            if [ -n "$PROJECT_NAME" ]; then
              echo "  <name>${PROJECT_NAME} - ${ARTIFACT_ID}</name>" >> "$POM_PATH"
            fi

            if [ -n "$PROJECT_DESCRIPTION" ]; then
              echo "  <description>${PROJECT_DESCRIPTION}</description>" >> "$POM_PATH"
            fi

            if [ -n "$PROJECT_URL" ]; then
              echo "  <url>${PROJECT_URL}</url>" >> "$POM_PATH"
            fi

            # Add license
            cat >> "$POM_PATH" <<EOF
            <licenses>
              <license>
                <name>${LICENSE_NAME}</name>
                <url>${LICENSE_URL}</url>
              </license>
            </licenses>
          </project>
          EOF
          }

          # Function to upload artifact
          upload_artifact() {
            local JAR_PATH=$1
            local JAR_FILENAME=$(basename "$JAR_PATH")

            # Extract artifact ID by removing version and .jar extension
            # Handles both: cubicolor-core-1.0.0.jar and cubicolor-core-1.0.0-SNAPSHOT.jar
            local ARTIFACT_ID=$(echo "$JAR_FILENAME" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?\.jar$//')

            # Extract actual version from filename
            local ACTUAL_VERSION=$(echo "$JAR_FILENAME" | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?)\.jar$/\1/')

            if [ ! -f "$JAR_PATH" ]; then
              echo "‚ö†Ô∏è  Warning: $JAR_PATH not found, skipping..."
              return
            fi

            # Skip plain JARs (Spring Boot generates these)
            if [[ "$JAR_PATH" == *"-plain.jar" ]]; then
              echo "‚è≠Ô∏è  Skipping plain JAR: $ARTIFACT_ID"
              return
            fi

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Processing: ${ARTIFACT_ID}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Use actual version from JAR filename
            local USE_VERSION="${ACTUAL_VERSION}"

            # Determine repository URL based on actual version
            local UPLOAD_REPO_URL
            if [[ "$USE_VERSION" == *"SNAPSHOT"* ]]; then
              UPLOAD_REPO_URL="${NEXUS_SNAPSHOT_URL}"
            else
              UPLOAD_REPO_URL="${NEXUS_RELEASE_URL}"
            fi

            # Ensure URL ends with slash (remove any existing trailing slash first, then add one)
            UPLOAD_REPO_URL="${UPLOAD_REPO_URL%/}/"

            # Maven path structure
            local MAVEN_BASE="${GROUP_PATH}/${ARTIFACT_ID}/${USE_VERSION}"
            local JAR_UPLOAD_URL="${UPLOAD_REPO_URL}${MAVEN_BASE}/${ARTIFACT_ID}-${USE_VERSION}.jar"
            local POM_UPLOAD_URL="${UPLOAD_REPO_URL}${MAVEN_BASE}/${ARTIFACT_ID}-${USE_VERSION}.pom"

            echo "   üìÇ Artifact ID: ${ARTIFACT_ID}"
            echo "   üè∑Ô∏è  Version: ${USE_VERSION}"
            echo "   üìÅ Source: ${JAR_PATH}"
            echo "   üåê Target: ${JAR_UPLOAD_URL}"
            echo ""

            # Upload JAR
            echo "   üì§ Uploading JAR..."

            # Create temporary file for curl output
            CURL_OUTPUT=$(mktemp)

            # Perform upload with detailed output
            HTTP_CODE=$(curl -w "%{http_code}" -o "$CURL_OUTPUT" \
              -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
              --upload-file "${JAR_PATH}" \
              -H "Content-Type: application/java-archive" \
              "${JAR_UPLOAD_URL}" 2>&1 | tail -n1)

            CURL_EXIT_CODE=$?

            echo "   üîç Debug Info:"
            echo "      - Curl exit code: ${CURL_EXIT_CODE}"
            echo "      - HTTP status: ${HTTP_CODE}"
            echo "      - URL: ${JAR_UPLOAD_URL}"

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "   ‚úÖ JAR uploaded successfully (HTTP ${HTTP_CODE})"
            else
              echo "   ‚ùå JAR upload failed (HTTP ${HTTP_CODE})"
              echo "   üìÑ Response body:"
              cat "$CURL_OUTPUT" | head -20
              rm -f "$CURL_OUTPUT"
              exit 1
            fi

            rm -f "$CURL_OUTPUT"

            # Generate and upload POM
            local POM_PATH="/tmp/${ARTIFACT_ID}-${USE_VERSION}.pom"
            generate_pom "$ARTIFACT_ID" "$POM_PATH" "$USE_VERSION"

            echo "   üì§ Uploading POM..."

            # Create temporary file for curl output
            local POM_CURL_OUTPUT=$(mktemp)

            HTTP_CODE=$(curl -w "%{http_code}" -o "$POM_CURL_OUTPUT" \
              -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
              --upload-file "${POM_PATH}" \
              -H "Content-Type: application/xml" \
              "${POM_UPLOAD_URL}" 2>&1 | tail -n1)

            POM_CURL_EXIT_CODE=$?

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "   ‚úÖ POM uploaded successfully (HTTP ${HTTP_CODE})"
            else
              echo "   ‚ö†Ô∏è  POM upload warning (HTTP ${HTTP_CODE}, curl exit: ${POM_CURL_EXIT_CODE})"
              if [ -f "$POM_CURL_OUTPUT" ]; then
                echo "   üìÑ Response:"
                cat "$POM_CURL_OUTPUT" | head -10
              fi
            fi

            rm -f "$POM_PATH" "$POM_CURL_OUTPUT"
          }

          # Find and upload all JARs
          echo "üîç Searching for artifacts..."
          echo ""

          UPLOADED=0
          while IFS= read -r jar_file; do
            upload_artifact "$jar_file"
            UPLOADED=$((UPLOADED + 1))
          done < <(find artifacts -type f -name "*.jar" | grep -v -- '-plain.jar')

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ú® Test Publishing Complete!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ Total artifacts tested: ${UPLOADED}"
          echo "üìç Repository: ${REPO_URL}"
          echo "üè∑Ô∏è  Version: ${VERSION}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
